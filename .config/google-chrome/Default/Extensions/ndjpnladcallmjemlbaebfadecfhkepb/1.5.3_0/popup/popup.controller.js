!function(){"use strict";function e(){return{require:"ngModel",restrict:"A",link:function(e,n,t,o){n.bind("change",function(e){o.$setViewValue(e.target.files)})}}}function n(e){return{require:"ngModel",restrict:"A",link:function(n,t,o,i){t.bind("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"}),t.bind("drop",function(n){n.stopPropagation(),n.preventDefault(),e.trackEvent("OpenDocument_Local_AppDragAndDrop"),i.$setViewValue(n.originalEvent.dataTransfer.files)})}}}function t(e,n){return{restrict:"A",link:function(t,o){o.bind("mousedown keydown keypress",function(t){t.which!==e.JQUERY.EVENT_ID.MOUSEDOWN.LEFT_BUTTON_CLICK&&t.which!==e.JQUERY.EVENT_ID.KEYPRESS.ENTER||(n.trackEvent("OpenDocument_Local"),angular.element(t.currentTarget).children("#file_picker").trigger("click"),t.preventDefault())})}}}function o(e,n,t,o,i,s,r,l,c,a){function u(){L.getSignInInfo(function(e){L.hasSignedIn=e,L.hasSignedIn===L.constants.SIGNINSTATUS.HASSIGNININFO&&p()}),L.storage.get("webRedirect_disabled").then(function(e){L.webRedirectInputChecked=!(Utilities.isNotUndefinedOrNull(e.webRedirect_disabled)&&e.webRedirect_disabled)}),o.getEnabledSetting().then(function(e){o.setEnabledSetting(e),L.telemetryInputChecked=e})}function d(){l.getUserPhoto().then(function(e){L.profilePicture=e},function(e){L.profilePicture="",o.error(String.format("PopupController.getUserPhoto: Profile Picture Error - {0}",e))})}function I(e){L.currentViewMode=L.currentViewMode===e?L.constants.MENU_VIEWMODE.NONE:L.currentViewMode=e}function p(){o.debug("PopupController.refreshSignInStatus(): Method start"),L.userService.getUserType().then(function(e){o.debug(String.format("PopupController.getSignInStatus(): hasSignedIn: {0}",e)),o.trackEvent("PopupSignedIn_"+e),n.userType=e,L.hasSignedIn=e===L.constants.USER_TYPE.NONE?L.constants.SIGNINSTATUS.NONE:L.constants.SIGNINSTATUS.SIGNEDIN,L.hasSignedIn===L.constants.SIGNINSTATUS.SIGNEDIN&&(L.userService.waitForUserInfo(e).then(function(e){return Utilities.isUndefinedOrNull(e)?void o.warn("self.UserService.getUserInfo(): userInfo is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):Utilities.isUndefinedOrNull(e.email)?void o.warn("self.UserService.getUserInfo(): userInfo.email is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):void(L.username=e.email)}),d())})}function f(){L.currentViewMode=L.constants.MENU_VIEWMODE.NONE,L.hasSignedIn===L.constants.SIGNINSTATUS.SIGNEDIN&&N()}function S(e){o.trackEvent("PopupSignInLinkClick"),BrowserHandler.runtime.sendMessage({activity:L.constants.ACTIVITY.AUTHENTICATION.NAME,type:e}),window.close()}function N(){o.trackEvent("PopupSignOutLinkClick"),L.userService.logout(n.userType),L.hasSignedIn=L.constants.SIGNINSTATUS.NONE,n.userType=L.constants.USER_TYPE.NONE,r.remove("localRecentDocuments")}function E(){o.trackEvent("PopupSignupLinkClick"),Utilities.navigateToUrlWithNewTab(L.constants.LINKS.SIGNUP,!0)}function g(){L.telemetryInputChecked=!L.telemetryInputChecked,o.setEnabledSetting(L.telemetryInputChecked),o.trackEvent("PopupTelemetryInputChecked",{enabled:L.telemetryInputChecked})}function U(){L.webRedirectInputChecked=!L.webRedirectInputChecked,L.storage.set({webRedirect_disabled:!L.webRedirectInputChecked}),o.trackEvent("PopupWebRedirectChecked",{enabled:L.webRedirectInputChecked})}function T(){Utilities.navigateToUrlWithNewTab(BrowserHandler.extension.getURL(L.constants.LINKS.FEEDBACK_URL),!0)}function O(){L.accountPanelOpened=!L.accountPanelOpened}function P(){o.trackEvent("PopupOpenDocument_"+n.userType),L.userService.getUserInfo(n.userType,function(e){return Utilities.isUndefinedOrNull(e)?void o.warn("PopupController.openDocument(): invalid userInfo"):Utilities.isUndefinedOrNull(e.serviceInfo)||Utilities.isUndefinedOrNull(e.serviceInfo.resource)?void o.warn("PopupController.openDocument(): invalid serviceInfo"):void Utilities.navigateToUrlWithNewTab(e.serviceInfo.resource,!0)})}function C(){L.userService.getUserInfo(n.userType,function(e){return Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.sharePointUrl)?void Utilities.navigateToUrlWithNewTab(e.sharePointUrl,!0):(o.warn("PopupController.openDocument(): invalid sharePointUrl"),void Utilities.navigateToUrlWithNewTab(L.constants.LINKS.APP.SHAREPOINT_DEFAULT,!0))})}function v(){o.trackEvent("PopupBrowseToRecents_"+n.userType),L.userService.getUserInfo(n.userType,function(e){return Utilities.isUndefinedOrNull(e)?void o.warn("PopupController.browseToRecents(): invalid userInfo"):Utilities.isUndefinedOrNull(e.serviceInfo)||Utilities.isUndefinedOrNull(e.serviceInfo.resource)?void o.warn("PopupController.browseToRecents(): invalid serviceInfo"):void Utilities.navigateToUrlWithNewTab(String.format("{0}{1}",e.serviceInfo.resource,k()?"":"/?qt=mru"),!0)})}function m(e,n){o.trackEvent("PopupCreateDocument_"+e.id);var t;if("OneDrive"===e.id)return void P();if("Outlook"===e.id)t=k()?L.constants.LINKS.APP.OUTLOOK_O365:L.constants.LINKS.APP.OUTLOOK_DEFAULT;else{if("SharePoint"===e.id)return void C();t=String.format(e.url,L.hasSignedIn!==L.constants.SIGNINSTATUS.SIGNEDIN?"0":k()?"2":"1")}Utilities.navigateToUrlWithNewTab(t,!(!Utilities.isUndefinedOrNull(n)&&!Utilities.isUndefinedOrNull(n.ctrlKey))||!n.ctrlKey)}function h(){L.loadFile(),o.trackEvent("PopupFileInputChange")}function b(){return o.trackEvent("PopupLoadFile",{filesSelectedCount:L.filesSelected.length}),L.filesSelected.length>1&&o.warn(String.format("loadFile called with {0} files selected",L.filesSelected.length)),L.constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(L.filesSelected[0].name)]?void w(L.filesSelected[0]):(o.info(String.format("PopupController.loadFile(): User attempted to open an unsupported file type of {0} extension",Utilities.getFileExtension(L.filesSelected[0].name))),void a.show(L.constants.NOTIFICATION.UNSUPPORTEDFILETYPE))}function k(){return n.userType===L.constants.USER_TYPE.O365}function w(e){BrowserHandler.extension.getBackgroundPage().postMessage(e,window.location)}var L=this;L.accountPanelOpened=!1,L.filesSelected=null,L.webRedirectInputChecked=!1,L.telemetryInputChecked=!1,L.onLine=!0,L.username="",L.profilePicture="",L.rtl=Utilities.isRTL(),L.isChrome=Utilities.isChrome(),L.onMenuItemClick=I,L.onSignOutClick=f,L.onWelcomeSignInClick=S,L.onProfileClick=O,L.onSignOutLinkClick=N,L.onSignupLinkClick=E,L.onWebRedirectInputChange=U,L.onTelemetryInputChange=g,L.onFileInputChange=h,L.onFeedbackClick=T,L.openDocument=P,L.browseToRecents=v,L.createDocument=m,L.loadFile=b,L.constants=s,L.storage=r,L.userService=l,L.localize=c,L.hasSignedIn=L.constants.SIGNINSTATUS.UNKNOWN,L.currentViewMode=L.constants.MENU_VIEWMODE.NONE,n.userType=L.constants.USER_TYPE.NONE,L.menuItems=[{id:"NewDocument",label:"CreateNewLabel",iconClass:"o365-Icon--circlePlus",viewMode:L.constants.MENU_VIEWMODE.NEW},{id:"OpenDocument",label:"OpenDocumentLabel",iconClass:"o365-Icon--folderOpen",viewMode:L.constants.MENU_VIEWMODE.OPEN},{id:"AccountInfo",label:"AccountLabel",iconClass:"o365-Icon--person2",viewMode:L.constants.MENU_VIEWMODE.ACCOUNT},{id:"Settings",label:"SettingsLabel",iconClass:"o365-Icon--gear",viewMode:L.constants.MENU_VIEWMODE.SETTINGS}],L.appLaunchers=[[{id:"Outlook",label:"OutlookAppName",iconClass:"ms-Icon ms-Icon--OutlookLogo ",colorClass:"outlook_color_fix",url:L.constants.LINKS.APP.OUTLOOK_DEFAULT,isBusinessOnly:!1},{id:"OneDrive",label:"OneDriveAppName",iconClass:"ms-Icon ms-Icon--OneDrive ",colorClass:"oneDrive_color_fix",url:L.constants.LINKS.APP.ONEDRIVE,isBusinessOnly:!1}],[{id:"WordOnline",label:"WordAppName",iconClass:"ms-Icon ms-Icon--WordLogo ",colorClass:"word_color_fix",url:L.constants.LINKS.APP.WORD,isBusinessOnly:!1},{id:"ExcelOnline",label:"ExcelAppName",iconClass:"ms-Icon ms-Icon--ExcelLogo ",colorClass:"excel_color_fix",url:L.constants.LINKS.APP.EXCEL,isBusinessOnly:!1}],[{id:"PowerPointOnline",label:"PowerPointAppName",iconClass:"ms-Icon ms-Icon--PowerPointLogo ",colorClass:"powerpoint_color_fix",url:L.constants.LINKS.APP.POWERPOINT,isBusinessOnly:!1},{id:"OneNoteOnline",label:"OneNoteAppName",iconClass:"ms-Icon ms-Icon--OneNoteLogo ",colorClass:"oneNote_color_fix",url:L.constants.LINKS.APP.ONENOTE,isBusinessOnly:!1}],[{id:"SharePoint",label:"SharePointSiteAppName",iconClass:"ms-Icon ms-Icon--SharepointLogo ",colorClass:"sharepoint_color_fix",url:L.constants.LINKS.APP.SHAREPOINT_DEFAULT,isBusinessOnly:!0},{id:"Teams",label:"TeamsAppName",iconClass:"ms-Icon ms-Icon--TeamsLogo ",colorClass:"teams_color_fix",url:L.constants.LINKS.APP.TEAMS,isBusinessOnly:!0}]],L.filePickers=[{id:L.constants.USER_TYPE.O365,label:"O365FilesLabel",fontClass:"o365-Icon--onedrive",isLocal:!1},{id:L.constants.USER_TYPE.MSA,label:"OneDriveFilesLabel",fontClass:"o365-Icon--onedrive",isLocal:!1},{id:"Local",label:"BrowseToOpenLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:L.isChrome,isEdge:!1},{id:L.constants.USER_TYPE.O365,label:"UploadToOneDriveBusinessLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:!1,isEdge:!L.isChrome},{id:L.constants.USER_TYPE.MSA,label:"UploadToOneDriveLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:!1,isEdge:!L.isChrome}],i.ready(function(){e(function(){o.trackEvent("PopupPageLoad")});for(var n=document.querySelectorAll(".ms-Spinner"),t=0;t<n.length;t++)new fabric.Spinner(n[t]);for(var i=document.querySelectorAll(".ms-CheckBox"),t=0;t<i.length;t++)new fabric.CheckBox(i[t])}),this.getSignInInfo=function(e){o.debug("PopupController.getSignInInfo(): Method start"),L.storage.get("refreshToken").then(function(n){e(Utilities.isNotUndefinedOrNull(n.refreshToken)?L.constants.SIGNINSTATUS.HASSIGNININFO:L.constants.SIGNINSTATUS.NONE)})},u()}angular.module("app.popup",[]).controller("PopupController",["$timeout","$scope","$q","$log","$document","constants","storage","userService","localize","notification",o]).directive("bindFileChange",e).directive("bindDragAndDrop",["$log",n]).directive("bindFileInputContainerClick",["constants","$log",t])}();