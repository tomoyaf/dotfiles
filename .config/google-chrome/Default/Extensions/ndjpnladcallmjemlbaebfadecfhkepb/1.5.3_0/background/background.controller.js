!function(){"use strict";function e(e,i,t,r,n,o,s,l,a,d){function c(e){return 0!==BrowserHandler.runtime.getURL("").search(new RegExp(e.origin,"i"))?void r.error(String.format("BackgroundController.receiveMessage: Error processing message with unrecognized origin {0}",e.origin)):"[object File]"!==Object.prototype.toString.call(e.data)?void r.error(String.format("BackgroundController.receiveMessage: Error processing message with event.data type {0}",Object.prototype.toString.call(e.data))):void p(e.data,function(e){Utilities.isUndefinedOrNull(e)||I(e,null)})}function u(e){Utilities.isUndefinedOrNull(e)&&(e=n.LINKS.PROGRESSPAGE_URL);var i=t.defer();return BrowserHandler.windows.getAll(function(t){0===t.length?BrowserHandler.windows.create({url:e,type:"normal"},function(e){i.resolve(e.tabs[0].id)}):BrowserHandler.tabs.create({url:e},function(e){i.resolve(e.id)})}),i.promise}function f(e,i){if(Utilities.isUndefinedOrNull(e))return void i(null);for(var t=0;t<e.length;++t)e[t].file(function(e){p(e,function(e){i(e)})})}function p(e,i){return Utilities.isUndefinedOrNull(e)?void i(null):void a.upload(e,n.FILE.ORIGIN.HTML5,function(e){i(e)})}function I(e,i){var n=t.defer();n.resolve(Utilities.isNotUndefinedOrNull(i)?i:u(e)),n.promise.then(function(i){return Utilities.isUndefinedOrNull(i)?void r.warn(String.format("BackgroundController.openFileUrlInTab(): tabIdPromise null or undefined")):void BrowserHandler.tabs.update(i,{url:e})})}function N(e,i){return e[i]&&e[i].toLowerCase().indexOf("private")!==-1}function O(){U(),r.getEnabledSetting().then(function(e){g(e)})}function U(){E=(new Date).toISOString();var e=window.localStorage.getItem("LastSession");Utilities.isNotUndefinedOrNull(e)&&(r.trackEvent("Session",JSON.parse(e)),window.localStorage.removeItem("LastSession")),BrowserHandler.windows.getAll(function(e){T=e.length})}function g(e){if(Utilities.isNotUndefinedOrNull(e)||(e=!0),Utilities.isNotUndefinedOrNull(BrowserHandler.runtime.setUninstallURL)){var i=Utilities.getManifest(),t=i?i.version:-1,r=Utilities.isExtensionInDevelopmentMode()?n.LINKS.OFFICE_HOME_DEV_URL:n.LINKS.OFFICE_HOME_URL;e&&(r=n.LINKS.UNINSTALL+"?version="+t,r=Utilities.isExtensionInDevelopmentMode()?r+"&isDebug=true":r),BrowserHandler.runtime.setUninstallURL(r)}}s.get("refreshToken").then(function(e){Utilities.isNotUndefinedOrNull(e.refreshToken)?Utilities.setIcon(n.BROWSER_ICON.DEFAULT):Utilities.setIcon(n.BROWSER_ICON.INACTIVE)});var w;s.get("webRedirect_disabled").then(function(e){w=Utilities.isNotUndefinedOrNull(e.webRedirect_disabled)&&e.webRedirect_disabled});var E,T=1;BrowserHandler.windows.onCreated.addListener(function(e){T++}),BrowserHandler.windows.onRemoved.addListener(function(e){if(T--,0===T&&Utilities.isNotUndefinedOrNull(E)){var i=(new Date).toISOString(),t=Date.parse(i)-Date.parse(E);window.localStorage.setItem("LastSession",JSON.stringify({start_time:E,end_time:i,duration:t}))}}),BrowserHandler.storage.onChanged.addListener(function(e,i){if(Utilities.isNotUndefinedOrNull(e.webRedirect_disabled))w=e.webRedirect_disabled.newValue;else if(Utilities.isNotUndefinedOrNull(e.refreshToken)){var t=e.refreshToken.newValue;Utilities.isNotUndefinedOrNull(t)?Utilities.setIcon(n.BROWSER_ICON.DEFAULT):Utilities.setIcon(n.BROWSER_ICON.INACTIVE)}});var v;BrowserHandler.webRequest.onSendHeaders.addListener(function(e){if("main_frame"===e.type)for(var i=0;i<e.requestHeaders.length;++i)if("Referer"===e.requestHeaders[i].name)return void(v=0===e.requestHeaders[i].value.indexOf("https://view.officeapps.live.com")?null:e.tabId)},{urls:["*://*/*.doc","*://*/*.doct","*://*/*.docx","*://*/*.dotx","*://*/*.odt","*://*/*.ppt","*://*/*.pot","*://*/*.pps","*://*/*.pptx","*://*/*.ppsx","*://*/*.odp","*://*/*.xls","*://*/*.xlsx","*://*/*.xlsm","*://*/*.xlsb","*://*/*.ods"]},["requestHeaders"]),BrowserHandler.webRequest.onHeadersReceived.addListener(function(e){if(!w&&"main_frame"===e.type&&!(Utilities.isUndefinedOrNull(e.responseHeaders)||Utilities.isUndefinedOrNull(v)||Utilities.isUndefinedOrNull(e.tabId)||v!==e.tabId)){for(var i={},t=0;t<e.responseHeaders.length;++t)i[e.responseHeaders[t].name]=e.responseHeaders[t].value;if(!N(i,"Cache-Control")&&!N(i,"Pragma"))return i["Content-Type"]?n.FILE.OFFICE_MIME_TYPES[i["Content-Type"].toLowerCase()]?(r.trackEvent("OpenDocument_BrowserWebDocument"),s.get("displayWebDocRedirectNotification").then(function(e){(Utilities.isUndefinedOrNull(e.displayWebDocRedirectNotification)||e.displayWebDocRedirectNotification===!0)&&o.show(n.NOTIFICATION.WEBDOCREDIRECT)}),{redirectUrl:"https://view.officeapps.live.com/op/view.aspx?src="+e.url}):void r.warn(String.format("onHeadersReceived called with Content-Type {0}",i["Content-Type"])):void 0}},{urls:["*://*/*.doc","*://*/*.doct","*://*/*.docx","*://*/*.dotx","*://*/*.odt","*://*/*.ppt","*://*/*.pot","*://*/*.pps","*://*/*.pptx","*://*/*.ppsx","*://*/*.odp","*://*/*.xls","*://*/*.xlsx","*://*/*.xlsm","*://*/*.xlsb","*://*/*.ods"]},["responseHeaders","blocking"]),BrowserHandler.webRequest.onBeforeRequest.addListener(function(e){if("main_frame"===e.type){r.trackEvent("OpenDocument_BrowserDragAndDrop");var i=e.tabId;return a.upload(e.url,n.FILE.ORIGIN.LOCAL_PATH,function(e){Utilities.isUndefinedOrNull(e)||I(e,i)}),{redirectUrl:n.LINKS.PROGRESSPAGE_URL}}},{urls:["file:///*.doc","file:///*.doct","file:///*.docx","file:///*.dotx","file:///*.odt","file:///*.ppt","file:///*.pot","file:///*.pps","file:///*.pptx","file:///*.ppsx","file:///*.odp","file:///*.xlsx","file:///*.xlsm","file:///*.xlsb","file:///*.ods"]},["blocking"]),BrowserHandler.webRequest.onErrorOccurred.addListener(function(e){r.error(String.format("BackgroundWebRequestOnErrorOccured - {0}",e.error))},{urls:["file:///*.doc","file:///*.doct","file:///*.docx","file:///*.dotx","file:///*.odt","file:///*.ppt","file:///*.pot","file:///*.pps","file:///*.pptx","file:///*.ppsx","file:///*.odp","file:///*.xlsx","file:///*.xlsm","file:///*.xlsb","file:///*.ods"]}),BrowserHandler.runtime.onInstalled.addListener(function(e){var i=Utilities.getManifest(),t=i?i.version:-1;"install"===e.reason?(r.trackEvent(String.format("AppInstalled_{0}",t)),o.show(n.NOTIFICATION.FILEACCESS),BrowserHandler.runtime.getPlatformInfo(function(e){"cros"===e.os&&o.show(n.NOTIFICATION.SETDEFAULT)})):"update"===e.reason&&(r.trackEvent(String.format("AppUpdated_{0}",t),{previousVersion:e.previousVersion}),Utilities.isNotUndefinedOrNull(window.localStorage.getItem(n.OAUTH.SERVICE_ID))&&(s.clear(),window.localStorage.clear()),s.get("userInfo").then(function(e){Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.userInfo)&&(Utilities.isNotUndefinedOrNull(e.userInfo.id)||Utilities.isNotUndefinedOrNull(e.userInfo.profile))&&(s.clear(),window.localStorage.clear())}))}),BrowserHandler.notifications.onButtonClicked.addListener(function(e){switch(e){case n.NOTIFICATION.AUTOSAVE.id:s.set({displayAutoSaveNotification:!1});break;case n.NOTIFICATION.WEBDOCREDIRECT.id:s.set({displayWebDocRedirectNotification:!1})}}),BrowserHandler.notifications.onClicked.addListener(function(e){switch(e){case n.NOTIFICATION.FILEACCESS.id:BrowserHandler.tabs.create({url:n.LINKS.SETTINGS_URL});break;case n.NOTIFICATION.INVALIDSUBSCRIPTION.id:BrowserHandler.tabs.create({url:n.LINKS.OFFICE_URL})}}),BrowserHandler.runtime.onMessage.addListener(function(e){switch(r.debug(String.format("BackgroundController.onMessage: Processing request activity {0}",e.activity)),e.activity){case n.ACTIVITY.TELEMETRY.NAME:switch(e.command){case n.TELEMETRY.COMMAND.SET_DISABLED:r.setEnabledSetting(e.enabled),g(e.enabled);break;case n.TELEMETRY.COMMAND.TRACK_EVENT:r.trackEvent(e.eventName,e.properties,e.measurements);break;case n.TELEMETRY.COMMAND.TRACK_TRACE:r.trackTrace(e.message,e.properties)}break;case n.ACTIVITY.NOTIFICATION.NAME:o.show(e.notification);break;case n.ACTIVITY.AUTHENTICATION.NAME:l.login(e.type);break;case n.ACTIVITY.AUTHORIZATION.NAME:BrowserHandler.tabs.query({active:!0,lastFocusedWindow:!0},function(i){if(Utilities.isUndefinedOrNull(i)||Utilities.isUndefinedOrNull(i[0]))return void r.error(String.format("BackgroundController.onMessage: Error processing request activity {0}; active tab undefined or null",e.activity));var t=i[0];s.get("loginTabId").then(function(i){if(Utilities.isUndefinedOrNull(i.loginTabId)||i.loginTabId!==t.id)return void r.error(String.format("BackgroundController.onMessage: Processing request activity {0}; loginTabId undefined or null or different from storage",e.activity));s.remove("loginTabId"),BrowserHandler.tabs.remove(t.id);var o=Utilities.deserializeQuery(e.query);o.hasOwnProperty(n.OAUTH.CODE)&&l.authenticate(e.type,o.code)})})}}),Utilities.isChrome()&&(BrowserHandler.runtime.onMessageExternal.addListener(function(e,i,t){switch(e.command){case n.COPY_PASTE.TEST:return d.handleTestCommand(e,i,t);case n.COPY_PASTE.COPY:return d.handleCopyCommand(e,i,t);case n.COPY_PASTE.PASTE:return d.handlePasteCommand(e,i,t);default:return!1}}),e.addEventListener("paste",d.onPasteEvent)),BrowserHandler.tabs.onReplaced.addListener(function(e,i){s.set({loginTabId:e})}),BrowserHandler.runtime.getPlatformInfo(function(e){"cros"===e.os&&BrowserHandler.fileBrowserHandler.onExecute.addListener(function(e,i){var t=i.entries;f(t,function(e){Utilities.isUndefinedOrNull(e)||I(e,null)})})}),window.addEventListener("message",c,!1),O()}angular.module("app.background",[]).controller("BackgroundController",["$window","$http","$q","$log","constants","notification","storage","userService","fileService","copyPasteService",e])}();