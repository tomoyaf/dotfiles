!function(){"use strict";function e(e,r,n,i){function t(e){var i=r.get("$http"),t={method:"GET",url:n.O365CONFIG.SHAREPOINT_URL,headers:{"X-UserType":n.USER_TYPE.O365}};i(t).success(function(r){return Utilities.isNotUndefinedOrNull(r.webUrl)?void e(r.webUrl):void e(null)}).error(function(){e(null)})}function o(t){var o=r.get("$http"),l={method:"GET",url:n.O365CONFIG.DISCOVERY_URL,headers:{"X-UserType":n.USER_TYPE.O365}};o(l).success(function(r){for(var o=0;o<r.value.length;++o)if("MyFiles"===r.value[o].capability&&"v2.0"===r.value[o].serviceApiVersion){var l={};return l.resource=r.value[o].serviceResourceId,l.url=r.value[o].serviceEndpointUri,void t(l)}u(),i.show(n.NOTIFICATION.INVALIDSUBSCRIPTION),e.info(String.format("o365UserService.DiscoverServiceEndpoint - Invalid resource")),t(null)}).error(function(){u(),i.show(n.NOTIFICATION.INVALIDSUBSCRIPTION),t(null)})}function u(){var e=r.get("userService");e.clearToken()}function l(r){var i={},t=s(r);return t&&t.hasOwnProperty("aud")&&(t.aud.toLowerCase()===n.O365CONFIG.CLIENT_ID.toLowerCase()?(t.hasOwnProperty("upn")?i.email=t.upn:t.hasOwnProperty("email")&&(i.email=t.email),t.hasOwnProperty("puid")&&(i.puid=t.puid)):e.error("IdToken has invalid aud field")),i}function s(r){var n=c(r);if(!n)return null;try{var i=n.JWSPayload,t=a(i);return t?JSON.parse(t):(this._logstatus("The returned id_token could not be base64 url safe decoded."),null)}catch(o){e.error("The returned id_token could not be decoded: "+o.stack)}return null}function a(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),window.atob?decodeURIComponent(escape(window.atob(e))):null}function c(r){var n=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/,i=n.exec(r);if(!i||i.length<4)return e.error("The returned id_token is not parseable."),null;var t={header:i[1],JWSPayload:i[2],JWSSig:i[3]};return t}this.type=n.USER_TYPE.O365,this.getConfig=function(){var e={url:n.O365CONFIG.INSTANCE+"token",params:{client_id:n.O365CONFIG.CLIENT_ID,client_secret:n.O365CONFIG.CLIENT_SECRET,redirect_uri:n.O365CONFIG.REDIRECT_URI,resource:n.O365CONFIG.DISCOVERY_RESOURCE},resource:n.O365CONFIG.DISCOVERY_RESOURCE,loginUrl:n.O365CONFIG.INSTANCE+"authorize?response_type=code&client_id="+n.O365CONFIG.CLIENT_ID+"&redirect_uri="+n.O365CONFIG.REDIRECT_URI,logoutUrl:n.O365CONFIG.LOGOUT_URI};return e},this.getResourceForEndpoint=function(e){var r=null;if(Utilities.isUndefinedOrNull(e))return r;for(var i in n.O365CONFIG.ENDPOINTS)n.O365CONFIG.ENDPOINTS.hasOwnProperty(i)&&e.indexOf(i)>-1&&(r=n.O365CONFIG.ENDPOINTS[i]);return r},this.lookupUserInfo=function(e,r){var i=l(e.id_token);o(function(e){i.serviceInfo=e,t(function(e){i.sharePointUrl=Utilities.isUndefinedOrNull(e)?n.LINKS.APP.SHAREPOINT_DEFAULT:e,r(i)})})}}angular.module("app.user").service("o365UserService",["$log","$injector","constants","notification",e])}();