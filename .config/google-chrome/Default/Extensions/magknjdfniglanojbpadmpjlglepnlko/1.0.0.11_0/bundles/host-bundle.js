(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){function isOldstyleGetManifest(message){return message&&message.method=="getManifestAsync"&&message.object=="runtime"&&message.callbackId}function getState(apiRoot,state,cb){var formattedState=apiRoot.runtime.getManifest();formattedState.connections=state.connections.map(function(c){return c&&{bufferLength:c.bufferLength,conf:c.portConf,id:c.id,closed:c.closed}}),formattedState.keepalives=state.keepalives.map(function(k){return k&&{clientId:k.clientId,conf:k.portConf,closed:k.closed}}),cb(formattedState)}function setupAdHoc(state){var apiRoot=state.apiRoot;if(apiRoot.runtime){if(!apiRoot.babelfish)apiRoot.babelfish={};apiRoot.babelfish.getState=apiRoot.runtime.getManifestAsync=getState.bind(null,apiRoot,state);function provideState(msg,sendResp){if(msg&&(msg.method=="getState"||isOldstyleGetManifest(msg))){apiRoot.babelfish.getState(sendResp);return false}return true}state.bootstrapHost.commands.push(provideState)}if(apiRoot.serial){apiRoot.serial.onReceiveError.forceDispatch=function(info){state.connections.forEach(function(c){if(c.apiEvent.methodName=="serial.onReceiveError.addListener"){c.apiEvent.methodRequest.getCallback().call(null,info)}})}}}module.exports.setupAdHoc=setupAdHoc},{}],2:[function(require,module,exports){var util=require("./util"),AckResponse=require("./responses.js").AckResponse,ArgsResponse=require("./responses.js").ArgsResponse,MethodRequest=require("./requests.js").MethodRequest,Arguments=require("./arguments.js").Arguments,log=new(require("./log.js").Log)("apieventemitter");var closingResponses={callingArguments:function(closingRequest){var method=util.path2callable(this.hostApi,this.reverser.path),args=this.methodRequest.args.forCalling();if(!closingRequest){method.apply(null,args);return null}if(this.reverser.path==closingRequest.method&&JSON.stringify(closingRequest.args.forSending())==JSON.stringify(this.methodRequest.args.forSending())){method.apply(null,args);this.destroy(true);return new AckResponse}return null},firstResponse:function(closingRequest){var fr=this.firstResponseMsg;if(!fr||fr.responseType!="ArgsResponse"){return null}var closingArg=fr.args[0];if(this.reverser.firstArgPath){closingArg=closingArg[this.reverser.firstArgPath]}if(!closingRequest){var mr=new MethodRequest(null,this.reverser.path,new Arguments([closingArg,function(){}]));mr.call(null,this.hostApi);return null}if(JSON.stringify(closingArg)==JSON.stringify(closingRequest.args.forSending()[0])&&closingRequest.method==this.reverser.path){this.destroy(true);return ArgsResponse.async(closingRequest,this.hostApi)}return null},serial:function(closingRequest){var oldfap=this.reverser.firstArgPath="connectionId";return closingResponses.firstResponse(closingRequest);this.reverser.firstArgPath=oldfap},"default":function(closingRequest){return closingResponses.serial(closingRequest)||closingResponses.firstResponse(closingRequest)||closingResponses.callingArguments(closingRequest)}};function ApiEventEmitter(methodRequest,reverser,hostApi,closeCb){var self=this;this.methodName=methodRequest.method;this.reverser=reverser;this.hostApi=hostApi;this.calledClosingRequests=[];this.methodRequest=methodRequest;this.methodRequest.args.setLens(function(cb){return function(){var args=[].slice.call(arguments);self.firstResponseMsg=self.firstResponseMsg||args[0];cb.apply(null,args)}});this.methodRequest.args.setLens=null;this.maybeRunCloser=function(closingRequest){if(self.closed){console.error("Trying to close a closed event emitter");return null}var closingResponseFactory=closingResponses[self.reverser.type]||closingResponses.default,ret=closingResponseFactory.call(self,closingRequest);if(ret){log.log("Closing["+self.reverser.type+"]:",ret,"with",closingRequest)}return ret};this.closeCb=closeCb}ApiEventEmitter.prototype={fire:function(){this.methodRequest.call(null,this.hostApi)},destroy:function(shallow){var self=this;if(this.closed)return;if(!shallow)this.maybeRunCloser();this.closed=true;this.closeCb();log.log("Disconected:",this.methodRequest.forSending())},missingReverseCb:function(){throw new Error("No such method as "+this.methodName)},missingMethodCb:function(){throw new Error("No reverse method for "+this.methodName)}};module.exports.ApiEventEmitter=ApiEventEmitter},{"./arguments.js":3,"./log.js":13,"./requests.js":17,"./responses.js":21,"./util":29}],3:[function(require,module,exports){module.exports.CallbackArgument=require("./arguments/callback.js");module.exports.DataArgument=require("./arguments/data.js");module.exports.DatabufferArgument=require("./arguments/databuffer.js");module.exports.BasicArgument=require("./arguments/basic.js");module.exports.Arguments=require("./arguments/container.js");module.exports.argumentFactory=require("./arguments/factory.js").argumentFactory;module.exports.argumentClasses=require("./arguments/factory.js").argumentClasses},{"./arguments/basic.js":4,"./arguments/callback.js":5,"./arguments/container.js":6,"./arguments/data.js":7,"./arguments/databuffer.js":8,"./arguments/factory.js":9}],4:[function(require,module,exports){var argumentClasses=require("./factory.js").argumentClasses;function BasicArgument(arg){this.value=arg}BasicArgument.canWrap=function(arg){return true};BasicArgument.prototype={forCalling:function(){return this.value},forSending:function(){return this.value}};argumentClasses.push(BasicArgument);module.exports=BasicArgument},{"./factory.js":9}],5:[function(require,module,exports){var argumentClasses=require("./factory.js").argumentClasses;function CallbackArgument(arg,replaceCb){if(!CallbackArgument.canWrap(arg)){throw Error("Cant wrap argument "+arg+"as a function")}this.replaceCb=replaceCb||null;this.id=arg.id||this.replaceCb&&this.replaceCb.id||Date.now()+Math.random();this.callback=arg instanceof Function?arg:replaceCb;if(this.callback){this.callback.id=this.id}this.placeholder={id:this.id,isCallback:true}}CallbackArgument.canWrap=function(arg){return arg&&(arg instanceof Function||arg.isCallback)};CallbackArgument.prototype={forCalling:function(){return this.lens?this.lens(this.callback):this.callback},forSending:function(){return this.placeholder},setLens:function(lens){this.lens=lens}};argumentClasses.push(CallbackArgument);module.exports=CallbackArgument},{"./factory.js":9}],6:[function(require,module,exports){var CallbackArgument=require("./callback.js"),argumentFactory=require("./factory.js").argumentFactory;function Arguments(arguments,replaceCb){this.arguments=arguments.map(function(a){return argumentFactory(a,replaceCb)})}Arguments.prototype={forCalling:function(){return this.arguments.map(function(a){return a.forCalling()})},forSending:function(){return this.arguments.map(function(a){return a.forSending()})},getCallback:function(){var cbArg=this.arguments.filter(function(a){return a instanceof CallbackArgument})[0],ret=cbArg?cbArg.forCalling():this.replaceCb;return ret},setLens:function(lens){if(this.replaceCb){this.replaceCb=lens(this.replaceCb)}this.arguments.forEach(function(a){if(a.setLens)a.setLens(lens)})}};module.exports=Arguments},{"./callback.js":5,"./factory.js":9}],7:[function(require,module,exports){var argumentClasses=require("./factory.js").argumentClasses,DatabufferArgument=require("./databuffer.js");function DataArgument(arg){if(!DataArgument.canWrap(arg)){throw new Error("Expected object like {data: ArrayBuffer}, got: ",arg)}this.arg=arg;this.data=new DatabufferArgument(arg.data)}DataArgument.canWrap=function(arg){return arg instanceof Object&&DatabufferArgument.canWrap(arg.data)};DataArgument.prototype={argCopy:function(){var ret={},self=this;Object.getOwnPropertyNames(this.arg).forEach(function(k){ret[k]=self.arg[k]});return ret},forCalling:function(){var ret=this.argCopy();ret.data=this.data.forCalling();return ret},forSending:function(){var ret=this.argCopy();ret.data=this.data.forSending();return ret},concat:function(msg){if(!msg.data||!msg.data.isArrayBuffer)return this;var ret=this.forSending();ret.data=this.data.concat(msg.data).forSending();return new DataArgument(ret)}};argumentClasses.push(DataArgument);module.exports=DataArgument},{"./databuffer.js":8,"./factory.js":9}],8:[function(require,module,exports){var argumentClasses=require("./factory.js").argumentClasses,util=require("../util.js");function DatabufferArgument(arg){if(!DatabufferArgument.canWrap(arg)){throw Error("Cant wrap argument "+arg+" as a databuffer")}this.buffer=arg instanceof ArrayBuffer?arg:null;this.obj=arg.isArrayBuffer?arg:null}DatabufferArgument.canWrap=function(arg){return arg&&(arg instanceof ArrayBuffer||arg.isArrayBuffer)};DatabufferArgument.prototype={forCalling:function(){return this.buffer||util.arrToBuf(this.obj.data)},forSending:function(){return this.obj||{data:util.bufToArr(this.buffer),isArrayBuffer:true}},concat:function(msg){if(!msg.isArrayBuffer)return this;var ret=this.forSending();ret.data=ret.data.concat(msg.data);return new DatabufferArgument(ret)}};argumentClasses.push(DatabufferArgument);module.exports=DatabufferArgument},{"../util.js":29,"./factory.js":9}],9:[function(require,module,exports){var argumentClasses=[];function argumentFactory(arg,replacingCb){var classes=argumentClasses.filter(function(ac){return ac.canWrap(arg)});return new classes[0](arg,replacingCb)}module.exports.argumentFactory=argumentFactory;module.exports.argumentClasses=argumentClasses},{}],10:[function(require,module,exports){var messageApi=require("./messaging.js");function BootstrapHost(){this.commands=[];this.listener=null;this.listen()}BootstrapHost.prototype={listen:function(){var self=this;this.listener=function(req,sender,sendResp){return self.commands.length==0||!self.commands.some(function(c){return!c(req,sendResp)})};messageApi.onMessageExternal.addListener(this.listener)},cleanup:function(){messageApi.onMessageExternal.removeListener(this.listener)}};module.exports.BootstrapHost=BootstrapHost},{"./messaging.js":14}],11:[function(require,module,exports){var server=require("./server.js"),srv=new server.HostServer(chrome);window.api=server;console.log("Serving...")},{"./server.js":27}],12:[function(require,module,exports){var Arguments=require("./arguments.js").Arguments,MethodRequest=require("./requests.js").MethodRequest,ApiEventEmitter=require("./apieventemitter.js").ApiEventEmitter,r=require("./responses.js"),util=require("./util.js"),closed=[],log=new(require("./log.js").Log)("hostconnection");require("./setimmediate.js");function HostConnection(port,hostApi,closeCb){var self=this;this.buffer=[];this.port=port;this.portConf=JSON.parse(port.name);this.id=this.portConf.id;this.closeCb=closeCb.bind(this);this.closed=false;var sendRaw=function(msg){self.pushRequest(msg)};this.methodRequest=MethodRequest.fromMessage(null,this.portConf.methodRequestMsg,sendRaw);log.log("Opening connection:",this.repr());this.apiEvent=new ApiEventEmitter(this.methodRequest,this.portConf.reverser,hostApi,this.close.bind(this));this.port.onMessage.addListener(function(msg){if(msg=="client created"){self.port.postMessage("ack");self.apiEvent.fire()}});log.log("Registering server side ondisconnect for method connection");this.port.onDisconnect.addListener(this.close.bind(this))}HostConnection.prototype={repr:function(){return this.id+" ( "+this.methodRequest.method+" )"},close:function(){if(this.closed)return;log.log("Closing connection:",this.repr());this.closed=true;this.port.disconnect();this.apiEvent.destroy();this.port=null;this.closeCb()},sendError:function(message){if(this.closed)return;this.port.postMessage(new r.ErrResponse(message).forSending());this.close()},pushRequest:function(reqMsg){if(this.closed)return;if(reqMsg.responseType=="ErrResponse"){this.sendError(reqMsg.err)}if(!this.apiEvent.firstResponseMsg){this.apiEvent.firstResponseMsg=reqMsg}if(this.buffer.length==0){setImmediate(this.setDtr.bind(this))}this.buffer.push(reqMsg);this.buffer.timestamp=Date.now()},setDtr:function(){if(this.port)this.port.postMessage({timestamp:this.buffer.timestamp,connection:this.id})},flushBuffer:function(callback){callback(this.buffer);this.buffer=[]},tryClosing:function(closingRequest){if(this.closed)return false;var ret=this.apiEvent.maybeRunCloser(closingRequest);if(this.apiEvent.closed){this.close()}return ret}};module.exports.HostConnection=HostConnection},{"./apieventemitter.js":2,"./arguments.js":3,"./log.js":13,"./requests.js":17,"./responses.js":21,"./setimmediate.js":28,"./util.js":29}],13:[function(require,module,exports){(function(global){var timeOffset=Date.now();global.debugBabelfish=false;function zeroFill(number,width){width-=number.toString().length;if(width>0){return new Array(width+(/\./.test(number)?2:1)).join("0")+number}return number+""}function Log(name,verbosity){this.verbosity=verbosity||1;this.name=name;this.resetTimeOffset();this.showTimes=false;this.error=this.console_("error",0);this.warn=this.console_("warn",1);this.info=this.console_("log",2);this.log=this.console_("log",3)}Log.prototype={timestampString:function(){var now=new Date(new Date-timeOffset+timeOffset.getTimezoneOffset()*6e4);var pad=function(n){if(n<10){return"0"+n}return n};return pad(now.getHours())+":"+pad(now.getMinutes())+":"+pad(now.getSeconds())+"."+zeroFill(now.getMilliseconds(),3)},resetTimeOffset:function(){timeOffset=new Date},console_:function(type,verbosity){var self=this;if(this.showTimes){return function(){if(self.verbosity>verbosity||global.debugBabelfish){return console[type].apply(console,[self.prefix()].concat(arguments))}}}if(this.verbosity>verbosity||global.debugBabelfish){return console[type].bind(console,this.prefix())}return function(){}},prefix:function(){if(this.showTimes)return"["+this.timestampString()+" : "+this.name+"]";return"["+this.name+"] "}};module.exports.Log=Log}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],14:[function(require,module,exports){(function(global){var DummyRuntime=require("./messaging/dummy.js").DummyRuntime,ChromeMessaging=require("./messaging/chrome.js").ChromeMessaging;var interfaces={chrome:ChromeMessaging,test:DummyRuntime};if(!global.chrome||!global.chrome.runtime||!global.chrome.runtime.sendMessage){global.MESSAGING_METHOD="test"}module.exports=new interfaces[global.MESSAGING_METHOD||"chrome"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./messaging/chrome.js":15,"./messaging/dummy.js":16}],15:[function(require,module,exports){function ChromeMessaging(){this.version=chrome.runtime.getManifest?chrome.runtime.getManifest().version:"1";this.onConnectExternal=chrome.runtime.onConnectExternal;this.onMessageExternal=chrome.runtime.onMessageExternal;this.sendMessage=chrome.runtime.sendMessage.bind(chrome.runtime);this.connect=chrome.runtime.connect.bind(chrome.runtime)}module.exports.ChromeMessaging=ChromeMessaging},{}],16:[function(require,module,exports){(function(global){global.APP_ID=global.APP_ID||"fakehostid";var DEBUG=false,stackDebug=false;var assert=require("assert"),maybeAsync=stackDebug?function(cb){cb()}:function(cb){var err=new Error("Stack before async message");setTimeout(function(){try{cb()}catch(e){console.log(e.stack);console.log(err.stack);throw err}})},dbg=function(){};if(DEBUG){dbg=console.log.bind(console,"[dummy messager]")}function validateMessage(msg){if(!msg||JSON.stringify(msg)=="{}"){throw new Error("Message should be something. Got:"+msg)}}function Event(jsonOnly,name,buffered){this.listeners=[];this.removed=[];this.name=name;if(buffered){this.buffer=[]}if(jsonOnly){this.wrap=function(args){return JSON.parse(JSON.stringify(args))}}else{this.wrap=function(a){return a}}}Event.prototype={addListener:function(cb){dbg("Adding listner: "+cb.id+" to "+this.name);var self=this;this.listeners=this.listeners.concat([cb]);(this.buffer||[]).forEach(function(args){maybeAsync(function(){self.listeners.some(function(l){return!l.apply(null,args)})})})},removeListener:function(cb){dbg("Removing listner: "+cb.id+" from "+this.name+" ("+this.listeners.map(function(l){return l.id})+" - "+this.removed+" )");this.listeners=this.listeners.filter(function(l){var same=cb===l,sameIds=cb.id&&l.id&&cb.id==l.id;return!(same||sameIds)})},trigger:function(varArgs){var args=[].slice.call(arguments),self=this,listeners=this.listeners;dbg("Triggering["+this.listeners.length+"]: "+this.name+"|"+(args[0]instanceof Port?"<port>":JSON.stringify(args)));if(this.buffer&&this.listeners.length==0){this.buffer.push(args);return}maybeAsync(function(){var tok=Math.random();listeners.some(function(l,i){return l.apply(null,args)===false})})}};function Runtime(){dbg("Creating runtime...");this.id=global.APP_ID;this.onConnectExternal=new Event(false,"onConnectExternal");this.onMessageExternal=new Event(true,"onMessageExternal");this.ports=[];this.version="1.0"}Runtime.prototype={sendMessage:function(hostId,message,cb){var sender=null;validateMessage(message);assert(message);assert(hostId);if(hostId!=this.id||global.blockMessaging){maybeAsync(cb);return}this.onMessageExternal.trigger(message,sender,cb)},connect:function(hostId,connectInfo){var clientPort=new Port(connectInfo.name,this),self=this;assert.equal(hostId,this.id);if(global.blockMessaging){setImmediate(function(){clientPort.onDisconnect.trigger(clientPort)});return clientPort}maybeAsync(function(){self.onConnectExternal.trigger(clientPort.otherPort)});return clientPort}};function Port(name,runtime,otherPort){this.name=name;this.runtime=runtime;runtime.ports=runtime.ports.concat([this]);this.prefix="Port"+(!otherPort?"<client>":"<host>");this.onDisconnect=new Event(false,this.prefix+".onDisconnect");this.onMessage=new Event(true,this.prefix+".onMessage",true);this.otherPort=otherPort||new Port(name,runtime,this);this.connected=true}Port.prototype={postMessage:function(msg){validateMessage(msg);this.otherPort.onMessage.trigger(msg)},disconnect:function(forceListeners){if(this.connected){var self=this;this.runtime.ports=this.runtime.ports.filter(function(p){return p!==self});this.connected=false;this.onMessage.listeners=[];if(forceListeners){this.onDisconnect.trigger()}this.onDisconnect.listeners=[];this.otherPort.disconnect(true)}}};global.chrome=global.chrome||{runtime:{id:APP_ID}};module.exports.DummyRuntime=Runtime;module.exports.Event=Event;module.exports.Port=Port}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{assert:30}],17:[function(require,module,exports){module.exports.BurstRequest=require("./requests/burst.js").BurstRequest;module.exports.GenericRequest=require("./requests/generic.js").GenericRequest;module.exports.MethodRequest=require("./requests/method.js").MethodRequest},{"./requests/burst.js":18,"./requests/generic.js":19,"./requests/method.js":20}],18:[function(require,module,exports){var Arguments=require("./../arguments.js").Arguements,log=new(require("./../log.js").Log)("burstrequest"),GenericRequest=require("./generic.js").GenericRequest,ErrResponse=require("./../responses.js").ErrResponse,BurstResponse=require("./../responses.js").BurstResponse;function BurstRequest(hostId,connection,callback){this.hostId=hostId;this.connection=connection;this.callback=callback;this.blocked=false}BurstRequest.maybeHandle=function(msg,connections,sendRespRaw){if(msg.requestType!="BurstRequest"){return false}var usefulCons=connections.filter(function(c){return msg.connId==c.id});if(usefulCons.length!=1){var errMsg="Burst request for connection "+msg.connId+" corresponds to "+usefulCons.length+" connections",errResp=new ErrResponse(errMsg);errResp.send(sendRespRaw);return true}function sendBuffer(buf){var br=new BurstResponse(buf,msg);br.send(sendRespRaw)}usefulCons[0].flushBuffer(sendBuffer);return true};BurstRequest.prototype=Object.create(GenericRequest.prototype);BurstRequest.prototype.forSending=function(){return{requestType:"BurstRequest",connId:this.connection.id}};BurstRequest.prototype.getCallback=function(){return this.callback};module.exports.BurstRequest=BurstRequest},{"./../arguments.js":3,"./../log.js":13,"./../responses.js":21,"./generic.js":19}],19:[function(require,module,exports){var genericRespHandler=require("./../responses.js").genericRespHandler,messageApi=require("./../messaging.js"),log=new(require("./../log.js").Log)("genericrequest");function GenericRequest(){}GenericRequest.prototype={forSending:function(){throw Error("forSending not implemented.")},send:function(cb,errorCb){var self=this,msg=this.forSending(),hostId=this.hostId;messageApi.sendMessage(hostId,msg,function(resp){genericRespHandler(resp,self,cb||function(err){if(err){throw err}})})}};module.exports.GenericRequest=GenericRequest},{"./../log.js":13,"./../messaging.js":14,"./../responses.js":21}],20:[function(require,module,exports){var Arguments=require("./../arguments.js").Arguments,GenericRequest=require("./generic.js").GenericRequest,util=require("./../util"),ArgsResponse=require("./../responses.js").ArgsResponse,ErrResponse=require("./../responses.js").ErrResponse,AckResponse=require("./../responses.js").AckResponse,log=new(require("./../log.js").Log)("methodrequest");function isNode(){if(typeof window==="undefined")return true;var backup=window,window_can_be_deleted=delete window;window=backup;return window_can_be_deleted}function MethodRequest(hostId,method,args,isReverser,noCallback,withError){this.method=method;this.args=args instanceof Arguments?args:new Arguments(args);this.hostId=hostId;this.isReverser=isReverser||false;this.noCallback=noCallback||false;this.withError=withError;if(!isNode()){this.trace=(new Error).stack}if(this.args.forSending().filter(function(a){return!!(a&&a.isCallback)}).length>1){throw Error("We do not support more than one callback in arguments.")}}MethodRequest.prototype=Object.create(GenericRequest.prototype);MethodRequest.fromMessage=function(hostId,msg,respCb){var args=new Arguments(msg.args,respCb);return new MethodRequest(hostId,msg.method,args)};function handleReverser(msg,connections,hostApi){if(!connections&&!msg.isReverser)return false;var req=MethodRequest.fromMessage(null,msg),response=connections.map(function(c){return c.tryClosing(req)}).reduce(function(a,b){return a||b},false);if(msg.isReverser&&!response){console.warn("You told me "+JSON.stringify(msg)+" was a reverser but i found nothing to reverse.");if(msg.noCallback){req.call(null,hostApi);return new ErrResponse("Tried to clean with "+msg.method+" but failed.","warning")}return ArgsResponse.async(req,hostApi)}return response}var messagesReceived=0;MethodRequest.maybeHandle=function(msg,hostApi,sendRespRaw,kw){kw=kw||{};var _sendRespRaw=function(sendMsg){if(++messagesReceived%1e3==0){log.log("Sending 1000 messages")}if(sendMsg.responseType=="ErrResponse"){console.error(msg,"->",sendMsg)}sendRespRaw(sendMsg)};if(msg.requestType!="MethodRequest"){return false}var resp=handleReverser(msg,kw.connections,hostApi);if(resp){resp.send(_sendRespRaw);return true}sendRespRaw=sendRespRaw||function(){};var sendArgsAsResponse=function(varArgs){var argsArr=[].slice.call(arguments),cbArgs=new Arguments(argsArr),argsResp=new ArgsResponse(cbArgs);if(chrome&&chrome.runtime&&chrome.runtime.lastError&&argsArr.length==0){new ErrResponse(chrome.runtime.lastError,"chrome.runtime.lastError").send(_sendRespRaw);return true}argsResp.send(_sendRespRaw)},methodArgs=new Arguments(msg.args,sendArgsAsResponse),methodCb=util.path2callable(hostApi,msg.method);if(!methodCb){resp=new ErrResponse("Method "+msg.method+" not found.");resp.send(_sendRespRaw);return true}try{if(kw.updateArgs)kw.updateArgs(methodArgs);methodCb.apply(null,methodArgs.forCalling());return true}catch(e){resp=new ErrResponse({message:"Error on calling "+msg.method+":"+e.message,stack:e.stack},"chrome.runtime.lastError");resp.send(_sendRespRaw);return true}if(msg.noCallback){(new AckResponse).send(_sendRespRaw);return true}};MethodRequest.prototype.forSending=function(){var ret={requestType:"MethodRequest",method:this.method,args:this.args.forSending(),noCallback:this.noCallback,isReverser:this.isReverser};return ret};MethodRequest.prototype.call=function(sendResp,hostApi){var self=this;function updateArgs(args){self.args=args}MethodRequest.maybeHandle(this.forSending(),hostApi,sendResp||this.getCallback(),{updateArgs:updateArgs})};MethodRequest.prototype.getCallback=function(){return this.args.getCallback()};MethodRequest.prototype.realCallback=function(){var self=this,callback=self.args.getCallback();return function(){var args=new Arguments([].slice.call(arguments)),resp=new ArgsResponse(args);callback.call(null,resp.forSending())}};module.exports.MethodRequest=MethodRequest},{"./../arguments.js":3,"./../log.js":13,"./../responses.js":21,"./../util":29,"./generic.js":19}],21:[function(require,module,exports){module.exports.ErrResponse=require("./responses/error.js");module.exports.BurstResponse=require("./responses/burst.js");module.exports.ArgsResponse=require("./responses/arguments.js");module.exports.AckResponse=require("./responses/ack.js");module.exports.genericRespHandler=require("./responses/generic.js").genericRespHandler},{"./responses/ack.js":22,"./responses/arguments.js":23,"./responses/burst.js":24,"./responses/error.js":25,"./responses/generic.js":26}],22:[function(require,module,exports){var GenericResponse=require("./generic.js").GenericResponse;require("./../setimmediate.js");function AckResponse(){}AckResponse.maybeHandle=function(msg,request,doneCb){if(msg.responseType!="AckResponse")return false;setImmediate(doneCb);return true};AckResponse.prototype=Object.create(GenericResponse.prototype);AckResponse.prototype.forSending=function(){return{responseType:"AckResponse"}};module.exports=AckResponse},{"./../setimmediate.js":28,"./generic.js":26}],23:[function(require,module,exports){var Arguments=require("./../arguments.js").Arguments,GenericResponse=require("./generic.js").GenericResponse;require("./../setimmediate.js");function ArgsResponse(args){this.cbArgs=args}ArgsResponse.async=function(mr,hostApi){var resp=new ArgsResponse;resp.mr=mr;resp.hostApi=hostApi;return resp};ArgsResponse.maybeHandle=function(msg,request,doneCb){if(msg.responseType!="ArgsResponse")return false;if(!request.getCallback()){doneCb(new Error("No real callback provided on the client."));return true}var cbArgs=new Arguments(msg.args),callArgs=cbArgs.forCalling(),callback=request.getCallback();callback.apply(null,callArgs);doneCb&&setImmediate(doneCb);return true};ArgsResponse.prototype=Object.create(GenericResponse.prototype);ArgsResponse.prototype.forSending=function(){return{responseType:"ArgsResponse",args:this.cbArgs.forSending()}};ArgsResponse.prototype.send=function(sendCb){if(this.mr){this.mr.call(sendCb,this.hostApi);return}sendCb(this.forSending())};module.exports=ArgsResponse},{"./../arguments.js":3,"./../setimmediate.js":28,"./generic.js":26}],24:[function(require,module,exports){var Arguments=require("./../arguments.js").Arguments,DataArgument=require("./../arguments.js").DataArgument,log=new(require("./../log.js").Log)("burstresponse"),GenericResponse=require("./generic.js").GenericResponse,ArgsResponse=require("./arguments.js"),genericRespHandler=require("./generic.js").genericRespHandler;require("./../setimmediate.js");function BurstResponse(cbArgsArr,reqMessage){this.cbArgsArr=cbArgsArr;this.callbackId=reqMessage.callbackId}var servedBurstMetrics=[];BurstResponse.maybeHandle=function(msg,request,doneCb){if(msg.responseType!="BurstResponse")return false;function arrInQueue(responses,err){if(err){doneCb(err);return}if(responses.length==0){doneCb();return}setImmediate(function(){var car=responses[0],cdr=responses.slice(1);if(!request.closed){genericRespHandler(car,request,arrInQueue.bind(null,cdr));return}doneCb()})}function maybeConcatData(msgs){var dataSources={},concatArg=msgs.forEach(function(m,i){if(!(m.args&&DataArgument.canWrap(m.args[0])&&m.args.length==1)){dataSources[i]=m;return}var arg=m.args[0],backup=arg.data;arg.data=null;var token=JSON.stringify(arg);arg.data=backup;var ret=dataSources[token];if(ret){dataSources[token]=ret.concat(arg);return}dataSources[token]=new DataArgument(arg)});return Object.getOwnPropertyNames(dataSources).map(function(k){var concatArg=dataSources[k];if(concatArg instanceof DataArgument){return new ArgsResponse(new Arguments([concatArg.forSending()])).forSending()}return concatArg})}if(0){servedBurstMetrics.push({time:Date.now(),length:msg.cbArgsArr.length});var totalRequests=servedBurstMetrics.reduce(function(sum,m){return sum+m.length},0);log.log("Burst summary:",{requestPerSec:totalRequests*1e3/(Date.now()-servedBurstMetrics[0].time),totalRequests:totalRequests,currentRequests:msg.cbArgsArr.length})}arrInQueue(maybeConcatData(msg.cbArgsArr));return true};BurstResponse.prototype=Object.create(GenericResponse.prototype);BurstResponse.prototype.forSending=function(){return{responseType:"BurstResponse",cbArgsArr:this.cbArgsArr,callbackId:this.callbackId}};module.exports=BurstResponse},{"./../arguments.js":3,"./../log.js":13,"./../setimmediate.js":28,"./arguments.js":23,"./generic.js":26}],25:[function(require,module,exports){var GenericResponse=require("./generic.js").GenericResponse;function ErrResponse(error,type){this.error=error;this.type=type}ErrResponse.maybeHandle=function(msg,request,doneCb){if(msg&&msg.responseType!="ErrResponse")return false;var rawError=msg?msg.err:"Undefined message, probably host is disconnected.";if(request.trace){console.warn("Received error:",msg.err);console.warn(request.trace)}var withError=function(err,cb){cb();if(err){console.error("Uncaught:",err)}};if(request.getCallback()){(request.withError||withError)(rawError,request.getCallback());doneCb();return true}doneCb(rawError);return true};ErrResponse.prototype=new GenericResponse;ErrResponse.prototype.forSending=function(){return{responseType:"ErrResponse",err:this.error,type:this.type}};module.exports=ErrResponse},{"./generic.js":26}],26:[function(require,module,exports){function GenericResponse(){}GenericResponse.prototype={send:function(sendCb){return sendCb(this.forSending())},forSending:function(){throw new Error("Not implemented")}};function genericRespHandler(msg,request,done){function doneCb(err){done(err)}var responseTypesArr=[require("./error.js"),require("./burst.js"),require("./arguments.js"),require("./ack.js")];if(!responseTypesArr.some(function(RT){return RT.maybeHandle(msg,request,doneCb)})){done(new Error("Couldn't handle message: "+JSON.stringify(msg)))}}module.exports.GenericResponse=GenericResponse;module.exports.genericRespHandler=genericRespHandler},{"./ack.js":22,"./arguments.js":23,"./burst.js":24,"./error.js":25}],27:[function(require,module,exports){var HostConnection=require("./hostconnection.js").HostConnection,MethodRequest=require("./requests.js").MethodRequest,BurstRequest=require("./requests.js").BurstRequest,ErrResponse=require("./responses.js").ErrResponse,AckResponse=require("./responses.js").AckResponse,log=new(require("./log.js").Log)("server"),messageApi=require("./messaging.js"),BootstrapHost=require("./bootstraphost.js").BootstrapHost;require("./setimmediate.js");var state={connections:[],keepalives:[],uniqueId:0,version:messageApi.version};function HostKeepAliveConnection(port,closeCb){log.log("Creating host keepalive");var self=this;this.port=port;port.onDisconnect.addListener(this.close.bind(this));this.closeCb=closeCb.bind(null,this);this.clientId=state.uniqueId++;this.portConf=JSON.parse(port.name);port.onDisconnect.addListener(function(){log.log("Client disconnected:"+self.clientId);
});port.postMessage({clientId:self.clientId,version:state.version});log.log("Client connected:"+self.clientId);this.closed=false}HostKeepAliveConnection.is=function(port){return JSON.parse(port.name).type=="KeepAliveConnection"};HostKeepAliveConnection.prototype={maybeClose:function(c){if(c.clientId==this.clientId){c.close()}},close:function(){if(this.closed)return;this.closed=true;this.closeCb();this.port.disconnect();this.port=null}};function getKeepAliveConnection(hostId,connectCb,disconnectCb,timeout){messageApi=require("./messaging.js");var portName=JSON.stringify({type:"KeepAliveConnection"}),port=messageApi.connect(hostId,{name:portName});if(disconnectCb){log.log("Detected disconnect cb on client keepalive");port.onDisconnect.addListener(function(){disconnectCb()})}var gotToken=false;port.onMessage.addListener(function tokenizer(msg){port.onMessage.removeListener(tokenizer);gotToken=true;if(!msg){log.warn("Empty message came on keepalive port.");disconnectCb("no_host");port.disconnect();return true}if(msg&&msg.version&&msg.version.split(".")[0]!=messageApi.version.split(".")[0]){log.warn("Received bad app version:",msg.version);disconnectCb("bad_version");port.disconnect();return true}if(typeof msg.clientId!=="number"){return false}var token={port:port,version:msg.version,clientId:msg.clientId,disconnectCb:disconnectCb};setImmediate(connectCb.bind(null,token))});if(typeof timeout!=="undefined"){setTimeout(function(){if(gotToken)return;log.warn("Host keepalive connection was silent for too long.");disconnectCb("timeout");port.disconnect();return true},timeout)}}function HostServer(apiRoot){if(state.apiRoot===apiRoot){throw Error("You are trying to host a second server on the same api.")}var adhoc=require("./adhoc/host.js");apiRoot.messageApi=messageApi;apiRoot.serverId=Math.random();state.apiRoot=apiRoot;state.bootstrapHost=new BootstrapHost;adhoc.setupAdHoc(state);function closeCb(connection){var len=state.connections.length;state.connections=state.connections.filter(function(c){return c!==connection});log.log("Cleanined:",connection.repr(),"(before: ",len,"after: ",state.connections.length,")")}function tabDiedCb(keepalive){state.connections.forEach(function(c){keepalive.maybeClose(c)});state.keepalives=state.keepalives.filter(function(ka){return!ka.closed})}function messageHandle(message,sender,sendResp){return MethodRequest.maybeHandle(message,apiRoot,sendResp,{connections:state.connections})||BurstRequest.maybeHandle(message,state.connections,sendResp)||new ErrResponse("Nothing to do for message."+JSON.stringify(message),false).send(sendResp)}function connectHandle(port){if(HostKeepAliveConnection.is(port)){var keepalive=new HostKeepAliveConnection(port,tabDiedCb);state.keepalives.push(keepalive);return}var conn=new HostConnection(port,apiRoot,function(){closeCb(conn)});state.connections.push(conn)}messageApi.onConnectExternal.addListener(connectHandle);log.log("Listening on connections...");messageApi.onMessageExternal.addListener(messageHandle);log.log("Listening on messages...");function cleanUp(){log.log("Cleaning connect");messageApi.onConnectExternal.removeListener(connectHandle);log.log("Cleaning message");messageApi.onMessageExternal.removeListener(messageHandle);state.connections.forEach(function(c){c.close()});state.keepalives.forEach(function(k){k.close()});state.bootstrapHost.cleanup();state.apiRoot=null}return cleanUp}module.exports.state=state;module.exports.HostServer=HostServer;module.exports.getKeepAliveConnection=getKeepAliveConnection;module.exports.messageApi=messageApi},{"./adhoc/host.js":1,"./bootstraphost.js":10,"./hostconnection.js":12,"./log.js":13,"./messaging.js":14,"./requests.js":17,"./responses.js":21,"./setimmediate.js":28}],28:[function(require,module,exports){(function(global){function isApp(){return!!chrome.runtime.getManifest}if(!(global.postMessage&&global.addEventListener)||isApp()){global.setImmediate=global.setTimeout.bind(global);global.clearTimeout=global.clearTimeout.bind(global)}else{(function(){"use strict";var i=0;var timeouts={};var messageName="setImmediate"+(new Date).getTime();function post(fn){if(i===4294967296)i=0;if(++i in timeouts)throw new Error("setImmediate queue overflow.");timeouts[i]=fn;global.postMessage({type:messageName,id:i},"*");return i}function receive(ev){if(ev.source!==window)return;var data=ev.data;if(data&&data instanceof Object&&data.type===messageName){ev.stopPropagation();var id=ev.data.id;var fn=timeouts[id];if(fn){delete timeouts[id];fn()}}}function clear(id){delete timeouts[id]}global.addEventListener("message",receive,true);global.setImmediate=post;global.clearImmediate=clear})()}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],29:[function(require,module,exports){function errorThrower(name){return function(){throw new Error("No such method: "+name)}}function arrToBuf(hex){var buffer=new ArrayBuffer(hex.length);var bufferView=new Uint8Array(buffer);for(var i=0;i<hex.length;i++){bufferView[i]=hex[i]}return buffer}module.exports.arrToBuf=arrToBuf;function bufToArr(bin){var bufferView=new Uint8Array(bin);var hexes=[];for(var i=0;i<bufferView.length;++i){hexes.push(bufferView[i])}return hexes}module.exports.bufToArr=bufToArr;function path2callable(object,name,callable){var names=name.split("."),method=names.pop(),obj=names.reduce(function(ob,meth){return ob[meth]},object)||object,self=this;if(!obj[method]){console.warn("Tried to resolve bad object path: "+name);console.warn("Server:",object);return null}return obj[method].bind(obj)}module.exports.path2callable=path2callable},{}],30:[function(require,module,exports){var util=require("util/");var pSlice=Array.prototype.slice;var hasOwn=Object.prototype.hasOwnProperty;var assert=module.exports=ok;assert.AssertionError=function AssertionError(options){this.name="AssertionError";this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;if(options.message){this.message=options.message;this.generatedMessage=false}else{this.message=getMessage(this);this.generatedMessage=true}var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace){Error.captureStackTrace(this,stackStartFunction)}else{var err=new Error;if(err.stack){var out=err.stack;var fn_name=stackStartFunction.name;var idx=out.indexOf("\n"+fn_name);if(idx>=0){var next_line=out.indexOf("\n",idx+1);out=out.substring(next_line+1)}this.stack=out}}};util.inherits(assert.AssertionError,Error);function replacer(key,value){if(util.isUndefined(value)){return""+value}if(util.isNumber(value)&&!isFinite(value)){return value.toString()}if(util.isFunction(value)||util.isRegExp(value)){return value.toString()}return value}function truncate(s,n){if(util.isString(s)){return s.length<n?s:s.slice(0,n)}else{return s}}function getMessage(self){return truncate(JSON.stringify(self.actual,replacer),128)+" "+self.operator+" "+truncate(JSON.stringify(self.expected,replacer),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,"==",assert.ok)}assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,"==",assert.equal)};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,"!=",assert.notEqual)}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected)){fail(actual,expected,message,"deepEqual",assert.deepEqual)}};function _deepEqual(actual,expected){if(actual===expected){return true}else if(util.isBuffer(actual)&&util.isBuffer(expected)){if(actual.length!=expected.length)return false;for(var i=0;i<actual.length;i++){if(actual[i]!==expected[i])return false}return true}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime()}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase}else if(!util.isObject(actual)&&!util.isObject(expected)){return actual==expected}else{return objEquiv(actual,expected)}}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b){if(util.isNullOrUndefined(a)||util.isNullOrUndefined(b))return false;if(a.prototype!==b.prototype)return false;if(util.isPrimitive(a)||util.isPrimitive(b)){return a===b}var aIsArgs=isArguments(a),bIsArgs=isArguments(b);if(aIsArgs&&!bIsArgs||!aIsArgs&&bIsArgs)return false;if(aIsArgs){a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b)}var ka=objectKeys(a),kb=objectKeys(b),key,i;if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key]))return false}return true}assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected)){fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)}};assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,"===",assert.strictEqual)}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,"!==",assert.notStrictEqual)}};function expectedException(actual,expected){if(!actual||!expected){return false}if(Object.prototype.toString.call(expected)=="[object RegExp]"){return expected.test(actual)}else if(actual instanceof expected){return true}else if(expected.call({},actual)===true){return true}return false}function _throws(shouldThrow,block,expected,message){var actual;if(util.isString(expected)){message=expected;expected=null}try{block()}catch(e){actual=e}message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:".");if(shouldThrow&&!actual){fail(actual,expected,"Missing expected exception"+message)}if(!shouldThrow&&expectedException(actual,expected)){fail(actual,expected,"Got unwanted exception"+message)}if(shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual){throw actual}}assert.throws=function(block,error,message){_throws.apply(this,[true].concat(pSlice.call(arguments)))};assert.doesNotThrow=function(block,message){_throws.apply(this,[false].concat(pSlice.call(arguments)))};assert.ifError=function(err){if(err){throw err}};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){if(hasOwn.call(obj,key))keys.push(key)}return keys}},{"util/":34}],31:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],32:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;(function(){try{cachedSetTimeout=setTimeout}catch(e){cachedSetTimeout=function(){throw new Error("setTimeout is not defined")}}try{cachedClearTimeout=clearTimeout}catch(e){cachedClearTimeout=function(){throw new Error("clearTimeout is not defined")}}})();var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=cachedSetTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;cachedClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){cachedSetTimeout(drainQueue,0)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],33:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],34:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":33,_process:32,inherits:31}]},{},[11]);